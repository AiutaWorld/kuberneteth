#!/usr/bin/env ruby

require "yaml"

config      = YAML.load_file("kuberneteth.yaml")
nodes       = config["nodes"]
nodenumber  = nodes.length

#
# Sanity Checks
#
abort "Number of nodes is limited to 100" if nodenumber > 100

#
# Config Map
#
nodes.each_with_index do |node, index|
  num = format('%02d', index)
  node_id = "#{node["prefix"]}-#{node["name"]}-#{num}"
  File.open("deployment.yaml", "w") do |f|
    f.puts <<EOT
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gethconfig-#{node_id}
  namespace: default
  labels:
    name: gethconfig-#{node_id}
data:
  gethconfig: |-
    [Eth]
    NetworkId = #{config["eth"]["networkId"]}
    SyncMode = "fast"
    LightPeers = 20
    DatabaseCache = 128
    GasPrice = 20000000000
    EthashCacheDir = "ethash"
    EthashCachesInMem = 2
    EthashCachesOnDisk = 3
    EthashDatasetDir = "/etc/testnet/#{node_id}/.ethash"
    EthashDatasetsInMem = 1
    EthashDatasetsOnDisk = 2
    EnablePreimageRecording = false

    [Eth.GPO]
    Blocks = 10
    Percentile = 50

    [Node]
    DataDir = "/etc/testnet/#{node_id}/.ethereum"
    IPCPath = "/etc/testnet/#{node_id}/geth.ipc"
    HTTPPort = 85#{num}
    HTTPModules = ["net", "web3", "eth"]
    WSPort = 86#{num}
    WSModules = ["net", "web3", "eth"]

    [Node.P2P]
    MaxPeers = 25
    NoDiscovery = false
    BootstrapNodes = []
    StaticNodes = []
    TrustedNodes = []
    ListenAddr = ":303#{num}"
EOT
  end
end

#
# Service
#
File.open("deployment.yaml", "a") do |f|
  f.puts <<EOT
---
apiVersion: v1
kind: Service
metadata:
  name: geth-node-svc
spec:
  selector:
    app: kuberneteth
  type: NodePort
  ports:
EOT
end

nodes.each_with_index do |node, index|
  num = format('%02d', index)
  node_id = "#{node["prefix"]}-#{node["name"]}-#{num}"
  File.open("deployment.yaml", "a") do |f|
    f.puts <<EOT
    - name: #{node_id}-jsonrpc
      protocol: TCP
      port: 85#{num}
      targetPort: 85#{num}
      nodePort: 300#{num}
EOT
  end
end

#
# Genesis Pod
#
File.open("deployment.yaml", "a") do |f|
  f.puts <<EOT
---
apiVersion: v1
kind: Pod
metadata:
  name: geth-genesis-node-pod
  labels:
    app: kuberneteth
spec:
  containers:
  - name: geth-genesis-node-container
    image: mmeister/geth-node:genesis
  restartPolicy: Never
EOT
end

#
# Cluster Deployment
#
File.open("deployment.yaml", "a") do |f|
  f.puts <<EOT
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: geth-node-deployment
spec:
  strategy:
    type: Recreate
  replicas: 1
  template:
    metadata:
      name: geth-node-deployment
      labels:
        app: kuberneteth
    spec:
      containers:
EOT
end

nodes.each_with_index do |node, index|
  num = format('%02d', index)
  node_id = "#{node["prefix"]}-#{node["name"]}-#{num}"
  File.open("deployment.yaml", "a") do |f|
    f.puts <<EOT
      - name: #{node_id}-container
        image: ethereum/client-go:#{config["geth"]["version"]}
        args: [ "--config", "/etc/geth/#{node_id}/gethconfig.toml" ]
        ports:
          - containerPort: 85#{num}
          - containerPort: 303#{num}
        volumeMounts:
        - name: #{node_id}-persistent-storage
          mountPath: /etc/testnet/#{node_id}
        - name: #{node_id}-config-persistent-storage
          mountPath: /etc/geth/#{node_id}
EOT
  end
end

# Monitoring
File.open("deployment.yaml", "a") do |f|
  f.puts <<EOT
      - name: ethmonitor
        image: mmeister/ethmonitor
        env:
        - name: NUMBER_OF_CLUSTERS
          value: "#{nodenumber}"
        - name: NAME_PREFIX
          value: "node"
        - name: WS_SECRET
          value: "supersecretpassword"
        - name: WS_SERVER
          value: "localhost:3001"
        - name: RPC_PORT_PREFIX
          value: "85"
        ports:
          - containerPort: 3001
      volumes:
EOT
end

# Volumes
nodes.each_with_index do |node, index|
  num = format('%02d', index)
  node_id = "#{node["prefix"]}-#{node["name"]}-#{num}"
  File.open("deployment.yaml", "a") do |f|
    f.puts <<EOT
      - name: #{node_id}-persistent-storage
        hostPath:
          path: /var/lib/docker/geth-storage/#{node_id}
      - name: #{node_id}-config-persistent-storage
        configMap:
          name: gethconfig-#{node_id}
          items:
          - key: gethconfig
            path: gethconfig.toml
EOT
  end
end
